<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gestione Ore Lavoro</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root { --primary: #007AFF; --bg: #F2F2F7; --card: #FFFFFF; --text: #1C1C1E; --secondary: #8E8E93; --success: #34C759; --danger: #FF3B30; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding-bottom: 90px; color: var(--text); -webkit-tap-highlight-color: transparent; }
        .app-container { padding: 20px; max-width: 500px; margin: auto; }
        .card { background: var(--card); padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .hidden { display: none !important; }
        
        input, select { width: 100%; padding: 14px; border: 1px solid #d1d1d6; border-radius: 12px; box-sizing: border-box; font-size: 16px; margin-bottom: 15px; background: #fff; }
        .btn { width: 100%; background: var(--primary); color: white; border: none; padding: 16px; border-radius: 14px; font-size: 17px; font-weight: 600; cursor: pointer; }
        
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--success); color: white; padding: 12px 25px; border-radius: 25px; font-weight: bold; z-index: 3000; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; }

        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.85); backdrop-filter: blur(15px); display: flex; justify-content: space-around; padding: 10px 0 25px 0; border-top: 0.5px solid #d1d1d6; z-index: 100; }
        .nav-item { border: none; background: none; color: var(--secondary); display: flex; flex-direction: column; align-items: center; font-size: 10px; cursor: pointer; flex: 1; gap: 4px; }
        .nav-item.active { color: var(--primary); }
        .nav-svg { width: 24px; height: 24px; fill: currentColor; }

        .month-row { display: flex; justify-content: space-between; padding: 18px; background: white; border-radius: 15px; margin-bottom: 10px; cursor: pointer; font-weight: 600; border: 1px solid #e5e5ea; align-items: center; }
        .log-item { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #f2f2f7; font-size: 14px; cursor: pointer; }
        
        #detail-view, #edit-view { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg); z-index: 200; overflow-y: auto; padding: 20px; }
        .header-detail { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        
        .delete-btn { background: none; color: var(--danger); border: 1px solid var(--danger); margin-top: 10px; }
        .confirm-delete-box { background: #fff1f0; border: 2px solid var(--danger); padding: 15px; border-radius: 15px; margin-top: 10px; text-align: center; }
    </style>
</head>
<body>

<div id="toast">‚úÖ Operazione completata!</div>

<div class="app-container">
    <div id="screen-login">
        <div class="card" style="text-align: center; margin-top: 60px;">
            <svg class="nav-svg" style="width:60px; height:60px; color:var(--primary); margin-bottom:15px;" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            <h1>Benvenuto</h1>
            <input type="text" id="user-id" placeholder="Codice Personale" style="text-align: center; text-transform: uppercase;">
            <button class="btn" onclick="login()">Accedi</button>
        </div>
    </div>

    <div id="screen-form" class="hidden">
        <div class="card">
            <h2 style="margin-top:0">‚è±Ô∏è Registra Ore</h2>
            <label style="font-size: 11px; font-weight: bold; color: var(--secondary);">DATA</label>
            <input type="date" id="data">
            <label style="font-size: 11px; font-weight: bold; color: var(--secondary);">LUOGO</label>
            <input type="text" id="luogo" placeholder="Nome Cantiere">
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label style="font-size: 11px; font-weight: bold; color: var(--secondary);">INIZIO</label><input type="time" id="inizio"></div>
                <div style="flex:1"><label style="font-size: 11px; font-weight: bold; color: var(--secondary);">FINE</label><input type="time" id="fine"></div>
            </div>
            <button class="btn" onclick="salvaOra()">Salva Rapporto</button>
        </div>
    </div>

    <div id="screen-archive" class="hidden">
        <h2 style="margin-bottom:20px;">üìÖ Archivio Mensile</h2>
        <div id="months-container"></div>
    </div>
</div>

<div id="detail-view" class="hidden">
    <div class="header-detail">
        <button onclick="closeDetail()" style="border:none; background:#e5e5ea; padding:10px; border-radius:10px; font-weight:600;">‚Üê Chiudi</button>
        <h2 id="detail-title" style="margin:0; font-size:18px;">Mese</h2>
    </div>
    <div class="card" id="detail-list"></div>
    <div class="card" style="background: var(--primary); color: white; text-align: center;">
        <span style="font-size: 13px; opacity: 0.8;">TOTALE ORE</span><br>
        <strong style="font-size: 28px;"><span id="detail-total">0h 0m</span></strong>
    </div>
</div>

<div id="edit-view" class="hidden">
    <div class="header-detail">
        <button onclick="closeEdit()" style="border:none; background:#e5e5ea; padding:10px; border-radius:10px;">Annulla</button>
        <h2 style="margin:0; font-size:18px;">Modifica</h2>
    </div>
    <div class="card">
        <input type="hidden" id="edit-id">
        <label style="font-size: 11px; font-weight: bold;">LUOGO</label><input type="text" id="edit-luogo">
        <label style="font-size: 11px; font-weight: bold;">ORE TOTALI (es: 1.5 per 1h 30m)</label>
        <input type="number" step="0.01" id="edit-ore">
        
        <button class="btn" onclick="updateOra()">Salva Modifiche</button>
        <button class="btn delete-btn" id="pre-delete-btn" onclick="toggleConfirmDelete(true)">Elimina Rapporto</button>
        
        <div id="confirm-delete-box" class="confirm-delete-box hidden">
            <p style="color:var(--danger); font-weight:bold; margin-top:0;">Sei sicuro di voler cancellare?</p>
            <button class="btn" style="background:var(--danger);" onclick="deleteOra()">S√å, ELIMINA ORA</button>
            <button class="btn" style="background:#ccc; color:#333; margin-top:8px;" onclick="toggleConfirmDelete(false)">ANNULLA</button>
        </div>
    </div>
</div>

<nav id="navbar" class="bottom-nav hidden">
    <button class="nav-item active" id="nav-form" onclick="switchTab('form')">
        <svg class="nav-svg" viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/><path d="M12.5 7H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
        <span>Ore</span>
    </button>
    <button class="nav-item" id="nav-archive" onclick="switchTab('archive')">
        <svg class="nav-svg" viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/></svg>
        <span>Mesi</span>
    </button>
    <button class="nav-item" onclick="location.reload()">
        <svg class="nav-svg" viewBox="0 0 24 24"><path d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42C17.99 7.86 19 9.81 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-2.19 1.01-4.14 2.58-5.42L6.17 5.17C4.23 6.82 3 9.26 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.74-1.23-5.18-3.17-6.83z"/></svg>
        <span>Esci</span>
    </button>
</nav>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyDaQzWhr4z-2Js0TLi3b7j7KDs7yATgpDY",
      authDomain: "app-ore-lavoro.firebaseapp.com",
      projectId: "app-ore-lavoro",
      storageBucket: "app-ore-lavoro.firebasestorage.app",
      messagingSenderId: "193912143318",
      appId: "1:193912143318:web:03994b97b7ad1d085f3877"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let CURRENT_USER_ID = "";
    let database = [];
    let current_mKey = "";

    // FUNZIONE PER TRASFORMARE 1.5 IN "1h 30m"
    function formatOreMinuti(decimalHours) {
        const h = Math.floor(decimalHours);
        const m = Math.round((decimalHours - h) * 60);
        return `${h}h ${m}m`;
    }

    function login() {
        const id = document.getElementById('user-id').value.trim().toUpperCase();
        if(id.length < 2) return alert("Inserisci un codice");
        CURRENT_USER_ID = id;
        document.getElementById('screen-login').classList.add('hidden');
        document.getElementById('screen-form').classList.remove('hidden');
        document.getElementById('navbar').classList.remove('hidden');
        document.getElementById('data').valueAsDate = new Date();
        ascoltaDatiCloud();
    }

    function showToast(text) {
        const t = document.getElementById('toast');
        t.innerText = text;
        t.style.display = 'block';
        setTimeout(() => { t.style.display = 'none'; }, 3000);
    }

    function switchTab(tab) {
        document.getElementById('screen-form').classList.toggle('hidden', tab !== 'form');
        document.getElementById('screen-archive').classList.toggle('hidden', tab !== 'archive');
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById('nav-' + tab).classList.add('active');
        if(tab === 'archive') renderMonths();
    }

    async function salvaOra() {
        const d = document.getElementById('data').value;
        const l = document.getElementById('luogo').value || 'Senza nome';
        const i = document.getElementById('inizio').value;
        const f = document.getElementById('fine').value;
        if(!d || !i || !f) return alert("Compila tutto");

        const start = new Date(`2000-01-01T${i}`);
        const end = new Date(`2000-01-01T${f}`);
        let diff = (end - start) / 1000 / 60 / 60;
        if(diff < 0) diff += 24;

        await db.collection("ore_lavoro").add({
            userId: CURRENT_USER_ID,
            data: d,
            luogo: l,
            ore: diff,
            timestamp: Date.now()
        });
        showToast("‚úÖ Rapporto Salvato!");
        document.getElementById('luogo').value = "";
    }

    function ascoltaDatiCloud() {
        db.collection("ore_lavoro").where("userId", "==", CURRENT_USER_ID)
          .onSnapshot((snapshot) => {
              database = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              database.sort((a, b) => b.data.localeCompare(a.data));
              renderMonths();
              if(!document.getElementById('detail-view').classList.contains('hidden')) updateDetailUI();
          });
    }

    function renderMonths() {
        const container = document.getElementById('months-container');
        container.innerHTML = "";
        const groups = {};
        database.forEach(item => {
            const mKey = item.data.substring(0, 7);
            groups[mKey] = (groups[mKey] || 0) + item.ore;
        });
        Object.keys(groups).sort().reverse().forEach(mKey => {
            const dateObj = new Date(mKey + "-01");
            const nomeMese = dateObj.toLocaleString('it-IT', { month: 'long', year: 'numeric' }).toUpperCase();
            const div = document.createElement('div');
            div.className = 'month-row';
            div.onclick = () => { current_mKey = mKey; showMonthDetail(mKey, nomeMese); };
            div.innerHTML = `<span>${nomeMese}</span> <span>${formatOreMinuti(groups[mKey])} ></span>`;
            container.appendChild(div);
        });
    }

    function showMonthDetail(mKey, nomeMese) {
        document.getElementById('detail-title').innerText = nomeMese;
        updateDetailUI();
        document.getElementById('detail-view').classList.remove('hidden');
    }

    function updateDetailUI() {
        const list = document.getElementById('detail-list');
        const totalSpan = document.getElementById('detail-total');
        const monthData = database.filter(item => item.data.startsWith(current_mKey));
        let total = 0;
        list.innerHTML = "";
        monthData.forEach(item => {
            total += item.ore;
            const row = document.createElement('div');
            row.className = 'log-item';
            row.onclick = () => openEdit(item);
            row.innerHTML = `<span><strong>${item.data.split('-').reverse().join('/')}</strong><br>${item.luogo}</span><span>${formatOreMinuti(item.ore)}</span>`;
            list.appendChild(row);
        });
        totalSpan.innerText = formatOreMinuti(total);
    }

    function openEdit(item) {
        document.getElementById('edit-id').value = item.id;
        document.getElementById('edit-luogo').value = item.luogo;
        document.getElementById('edit-ore').value = item.ore;
        toggleConfirmDelete(false);
        document.getElementById('edit-view').classList.remove('hidden');
    }

    function toggleConfirmDelete(show) {
        document.getElementById('confirm-delete-box').classList.toggle('hidden', !show);
        document.getElementById('pre-delete-btn').classList.toggle('hidden', show);
    }

    async function updateOra() {
        const id = document.getElementById('edit-id').value;
        const l = document.getElementById('edit-luogo').value;
        const o = parseFloat(document.getElementById('edit-ore').value);
        await db.collection("ore_lavoro").doc(id).update({ luogo: l, ore: o });
        showToast("‚úÖ Modifica salvata!");
        closeEdit();
    }

    async function deleteOra() {
        const id = document.getElementById('edit-id').value;
        await db.collection("ore_lavoro").doc(id).delete();
        showToast("üóëÔ∏è Rapporto eliminato!");
        closeEdit();
    }

    function closeDetail() { document.getElementById('detail-view').classList.add('hidden'); }
    function closeEdit() { document.getElementById('edit-view').classList.add('hidden'); }
</script>
</body>
</html>
